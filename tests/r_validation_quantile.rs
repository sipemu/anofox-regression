//! R Validation Tests for Quantile Regression.
//!
//! These tests compare anofox-regression Quantile Regression implementation against R's quantreg package.
//! Data generated by tests/r_scripts/generate_quantile_validation.R
//!
//! Reference: R quantreg package (version 6.1)
//! https://cran.r-project.org/package=quantreg

use anofox_regression::solvers::{FittedRegressor, QuantileRegressor, Regressor};
use approx::assert_relative_eq;
use faer::{Col, Mat};

// =============================================================================
// Test 1: Simple Quantile Regression - Median (tau = 0.5)
// =============================================================================
// R Code: rq(y ~ x, tau = 0.5)

const N_QR1: usize = 50;

#[rustfmt::skip]
const X_QR1: [f64; 50] = [
    1.0000000000, 1.1836734694, 1.3673469388, 1.5510204082, 1.7346938776, 1.9183673469, 2.1020408163, 2.2857142857, 2.4693877551, 2.6530612245, 2.8367346939, 3.0204081633, 3.2040816327, 3.3877551020, 3.5714285714, 3.7551020408, 3.9387755102, 4.1224489796, 4.3061224490, 4.4897959184, 4.6734693878, 4.8571428571, 5.0408163265, 5.2244897959, 5.4081632653, 5.5918367347, 5.7755102041, 5.9591836735, 6.1428571429, 6.3265306122, 6.5102040816, 6.6938775510, 6.8775510204, 7.0612244898, 7.2448979592, 7.4285714286, 7.6122448980, 7.7959183673, 7.9795918367, 8.1632653061, 8.3469387755, 8.5306122449, 8.7142857143, 8.8979591837, 9.0816326531, 9.2653061224, 9.4489795918, 9.6326530612, 9.8163265306, 10.0000000000
];

#[rustfmt::skip]
const Y_QR1: [f64; 50] = [
    4.1854792236, 3.4413010822, 4.2992816690, 4.8173220202, 4.9526817088, 4.7757581172, 6.7417016912, 5.3203896704, 8.1962170345, 5.8963996645, 8.1058865504, 9.9839134502, 4.5811109176, 6.6093986195, 7.1190690422, 8.8266823800, 7.3483590425, 2.7081224998, 3.2047089599, 11.6982136333, 8.2936710404, 4.9596795175, 9.1279225829, 13.0097624795, 15.2370027269, 9.1841985504, 9.9203343334, 5.6852691747, 12.6274418756, 9.4653223311, 13.2478427481, 14.3998637409, 15.8758151725, 10.4419538174, 14.6965211099, 6.7653963349, 10.4326203048, 10.3770744798, 4.3371919273, 14.3923371710, 15.3801370151, 13.2558984613, 18.3748540984, 12.1138438306, 9.4093360738, 17.9030549363, 12.3400506064, 23.4042428116, 14.6068813933, 20.2782394170
];

const EXPECTED_INTERCEPT_QR1: f64 = 2.6995416827;
const EXPECTED_COEF_QR1: f64 = 1.2374676606;

#[test]
fn test_r_validation_quantile_median() {
    let x = Mat::from_fn(N_QR1, 1, |i, _| X_QR1[i]);
    let y = Col::from_fn(N_QR1, |i| Y_QR1[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.5)
        .with_intercept(true)
        .build()
        .fit(&x, &y)
        .expect("fit should succeed");

    let result = fitted.result();
    let intercept = result.intercept.expect("intercept should exist");

    // Quantile regression uses iterative methods, so we need looser tolerance
    // Tolerance: 0.1 for coefficients (different algorithms may converge differently)
    assert_relative_eq!(intercept, EXPECTED_INTERCEPT_QR1, epsilon = 1.0);
    assert_relative_eq!(result.coefficients[0], EXPECTED_COEF_QR1, epsilon = 0.2);

    // Verify tau
    assert_eq!(fitted.tau(), 0.5);
}

// =============================================================================
// Test 2: Multiple Quantiles (0.1, 0.25, 0.5, 0.75, 0.9)
// =============================================================================
// R Code: rq(y ~ x, tau = c(0.1, 0.25, 0.5, 0.75, 0.9))

const N_QR2: usize = 100;

#[rustfmt::skip]
const X_QR2: [f64; 100] = [
    6.2624534452, 2.1715769824, 2.1656731097, 3.8894502865, 9.4245569198, 9.6260801377, 7.3985527921, 7.3324590572, 5.3576129000, 0.0227296609, 6.0893745255, 8.3680155943, 7.5152256270, 4.5273157256, 5.3578999382, 5.3737669531, 0.0138084358, 3.5566595383, 6.1213309015, 8.2894213055, 3.5672199936, 4.1063512582, 5.7347589894, 5.8967830357, 7.1965729236, 3.9497304522, 9.1920392914, 9.6257029357, 2.3352352553, 7.2449759999, 9.0363452514, 6.0347408475, 6.3150729891, 9.3738584965, 8.5048275068, 5.7982089906, 8.2140392391, 1.1371860909, 7.6450775866, 6.2361345720, 1.4844660670, 0.8026446658, 4.6406955132, 7.7936816146, 7.3352795956, 8.1723044440, 1.7016248126, 9.4472032553, 2.9362384137, 1.4907205245, 7.1937859128, 3.2408595248, 7.7880949853, 3.9444100182, 6.7859286792, 7.7582504274, 1.8786904402, 0.2908581891, 1.3571379706, 6.8016417813, 9.3482295377, 5.5049408437, 6.0176623543, 1.9699448813, 5.3523661057, 1.7955573928, 4.5188649441, 3.1705335178, 1.1617467040, 1.8610215676, 7.2973009665, 4.1187207121, 4.1404968174, 4.8031012900, 4.2749446561, 1.3649036014, 8.2467940636, 5.9230424254, 7.9439697764, 7.6903242571, 9.1805641726, 8.6262977705, 3.1697523780, 2.5926057599, 7.4226645194, 7.4736111681, 9.1790403402, 7.9319120920, 1.3332961826, 2.8774975217, 1.9467614382, 7.8410938266, 1.2887216173, 1.2908928352, 0.7225311128, 0.5312948348, 5.3187443642, 1.1230824166, 7.4318771972, 7.3131547729
];

#[rustfmt::skip]
const Y_QR2: [f64; 100] = [
    12.2417750309, 4.9483166188, 3.6813279304, 6.9469643366, 18.4486171901, 20.3298076949, 19.9679327155, 15.8780154948, 9.9049301129, -0.7166080476, 11.3508730270, 16.1708893023, 15.8731808187, 11.7944774719, 16.3551710328, 12.7405744596, 6.2052742481, 6.2333452766, 13.9999835388, 19.9021039053, 6.3801918132, 11.6346862165, 14.6243777227, 10.9920477252, 14.9868007257, 8.5469807140, 17.5070548952, 25.9285069281, 4.8655117406, 18.3971544030, 17.5484966906, 11.9288964691, 16.2202353941, 20.6839937007, 16.2939141347, 10.7853641152, 17.0025517899, 3.3543748641, 16.2306424555, 14.0888260230, 3.8652467140, 7.3435645612, 12.0516871343, 14.8244145611, 20.9940196914, 17.4467839188, 10.3490835502, 19.8027872461, 7.3504032827, 4.0273033342, 18.4193499859, 6.5099414596, 14.9880639594, 9.9878083196, 18.1981537441, 15.9865074188, 3.3010556639, 2.8958534979, 3.6601511109, 14.4453028859, 22.5441965792, 15.1471542723, 14.2194299306, 3.5527627580, 10.3013007294, 5.1276245247, 11.0808609378, 6.9658149676, 1.5827822983, 3.2188912354, 14.4842387903, 8.2403853815, 7.2842903909, 11.1866805515, 8.2511676215, 3.5554877796, 16.7526184879, 12.5701353819, 17.5472906445, 19.4489174427, 18.5555148972, 18.5171718997, 11.4758871120, 10.3599147151, 14.3628899013, 14.5572975086, 21.8743332091, 18.2704512168, 2.6261554686, 7.0916232365, 4.6673884023, 15.4898128536, 1.9765846704, 6.6442196246, 2.4076278190, 1.0956701199, 15.1375855596, 2.0872762436, 14.0141516044, 19.9771981628
];

const EXPECTED_INTERCEPT_QR2_TAU50: f64 = 0.8117145339;
const EXPECTED_COEF_QR2_TAU50: f64 = 2.0102322559;

const EXPECTED_INTERCEPT_QR2_TAU25: f64 = -0.3861255708;
const EXPECTED_COEF_QR2_TAU25: f64 = 1.9994916438;

const EXPECTED_INTERCEPT_QR2_TAU75: f64 = 1.5249795720;
const EXPECTED_COEF_QR2_TAU75: f64 = 2.2169369436;

#[test]
fn test_r_validation_quantile_multiple_tau50() {
    let x = Mat::from_fn(N_QR2, 1, |i, _| X_QR2[i]);
    let y = Col::from_fn(N_QR2, |i| Y_QR2[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.5)
        .build()
        .fit(&x, &y)
        .expect("fit should succeed");

    let result = fitted.result();
    let intercept = result.intercept.expect("intercept should exist");

    assert_relative_eq!(intercept, EXPECTED_INTERCEPT_QR2_TAU50, epsilon = 1.0);
    assert_relative_eq!(result.coefficients[0], EXPECTED_COEF_QR2_TAU50, epsilon = 0.2);
}

#[test]
fn test_r_validation_quantile_multiple_tau25() {
    let x = Mat::from_fn(N_QR2, 1, |i, _| X_QR2[i]);
    let y = Col::from_fn(N_QR2, |i| Y_QR2[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.25)
        .build()
        .fit(&x, &y)
        .expect("fit should succeed");

    let result = fitted.result();
    let intercept = result.intercept.expect("intercept should exist");

    assert_relative_eq!(intercept, EXPECTED_INTERCEPT_QR2_TAU25, epsilon = 1.0);
    assert_relative_eq!(result.coefficients[0], EXPECTED_COEF_QR2_TAU25, epsilon = 0.2);
}

#[test]
fn test_r_validation_quantile_multiple_tau75() {
    let x = Mat::from_fn(N_QR2, 1, |i, _| X_QR2[i]);
    let y = Col::from_fn(N_QR2, |i| Y_QR2[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.75)
        .build()
        .fit(&x, &y)
        .expect("fit should succeed");

    let result = fitted.result();
    let intercept = result.intercept.expect("intercept should exist");

    assert_relative_eq!(intercept, EXPECTED_INTERCEPT_QR2_TAU75, epsilon = 1.5);
    assert_relative_eq!(result.coefficients[0], EXPECTED_COEF_QR2_TAU75, epsilon = 0.3);
}

// =============================================================================
// Test 3: Multiple Regression with Quantiles
// =============================================================================
// R Code: rq(y ~ X, tau = c(0.25, 0.5, 0.75))

const N_QR3: usize = 80;
const P_QR3: usize = 3;

#[rustfmt::skip]
const X_QR3: [f64; 240] = [
    -0.0750376604, -0.5824713069, 0.9099274305, 1.7952055561, -1.3652743990, 0.0621808778, -0.7404306197, -0.0231873816, 1.3221595329, -1.4353120561, 0.0331926742, -0.2050369615, -1.2373042469, -0.6281078971, -0.2900024697, 0.2058711545, 0.5884590316, -1.0243340147, 0.7650740010, -1.5543679640, -0.0432355142, 0.8834995535, -1.4583859870, -0.4127206492, 0.0354947246, 0.1143361989, -1.3794057599, -2.1333457249, -0.7488424346, -0.0428165699, 1.4140730787, 1.0587140596, -0.0861780973, 0.8695214048, -1.5386819647, -0.2614958264, 0.4106070401, -0.5045991104, 0.4470157515, 1.0183162522, -1.4114869554, -1.4545869369, 0.3584167409, -0.8825137456, 1.0894670718, -2.9815639275, 1.6617989402, -0.0912380677, 1.3168225960, 0.7922106634, 0.1943477774, -1.1160340527, -0.1253143496, -0.6790749781, -1.6581749664, -0.0396959983, -0.2113845589, -0.9029062753, -0.5096644027, -1.8410223834, -0.9263332521, 0.8820339622, 1.2449328804, -1.0512478083, -0.6650712351, 0.7340706396, -0.5089337678, -0.4272471327, -0.6238301485, 0.1979512120, 1.5005988001, -1.1406741537, 0.4968473747, 1.4083694576, -0.6233703735, -0.7416606646, 0.3766277300, -1.3101753516, 0.0781199236, -0.7954167696, 1.7664949433, -0.9364218280, 0.7039182938, -0.7558388194, -0.4681692910, -0.8444879925, -1.0915395998, -1.3233506253, -0.5915964052, 0.7483141463, -0.8215251908, -1.7645949477, -0.3885356562, -0.6692638716, 0.7045175117, -0.8276276946, -3.3493240811, 0.3425409520, -1.9310978856, 0.1777525769, 1.4018841941, 0.3730662650, -0.0486032520, 2.4634604732, 0.5676061400, 0.9688402998, 2.6514173999, -0.0344926185, -0.4096267000, -0.1036511010, -0.5746493794, -0.5133514127, -0.0552973858, -0.9784380649, 0.0587080378, 0.0618109094, -0.3804868679, 1.4180621632, -0.8185243547, -0.4570375583, 0.2174944974, 0.6250464654, 0.5173766402, -0.1853814700, -0.0640336771, -0.7043990826, -0.6996975052, 0.5609027510, 0.0478343679, 0.5669677091, -1.1961596010, 0.9596008212, 0.5072521011, -0.3741122424, 1.4204473336, 1.6943746004, 0.5167791405, -0.0481044125, -1.2802457728, -0.4896814839, 1.2876954571, 0.9305014473, 0.7261406964, -0.1930611408, -0.5612293824, 0.7750486125, -0.2675638006, -1.1107720612, -0.6004009024, -0.3192017223, 1.1680297723, 1.6973634863, 0.9313464033, -1.1518232485, 0.1216725638, -1.1603817788, 1.0041581897, 0.5446949400, 1.6023169862, -0.1105703798, 0.0126452264, 0.5743624485, 0.5428313755, -0.5304505296, 0.1811529409, 1.1606279168, 0.6364921675, 0.5952489309, -0.5297222028, 0.4501336578, 0.3189239081, -0.3237107388, 0.8971662769, -0.1518715500, 0.2580822568, 1.7314954868, 1.3691769820, -0.0580369219, 0.4494204580, 1.0770817162, 0.1864831797, 1.5691580779, -0.2267570412, 0.7663612139, -0.3121133038, -1.3554575804, -0.9056467765, -0.6511869229, -1.0447499459, 1.5939187240, 0.5423479040, -2.3663335111, 0.4711079933, -0.2316080839, 0.0936844299, -1.2950896078, -0.8487846087, -2.2900556876, 1.2828560125, 1.6637801895, 0.4014362549, -1.5093425111, -1.1383658719, 0.3377412043, -1.4726281439, -0.2918773295, -2.0296453125, -0.5940445331, -1.0545506995, -1.0784796191, 1.2811232385, 0.0810282612, -0.9930789901, -0.7570715314, 0.0092435155, 1.4093269403, 0.2932751464, 0.2971348260, -1.4025303597, 0.1042851406, 0.3714197034, -1.6761573871, 1.7846714732, -2.2769846534, -1.5898211049, -0.2463742549, -0.3537498802, 0.2683726076, 0.4541753279, -2.6882472738, 0.8666501724, 0.1687397014, -1.0908240619, -0.3803481143, -0.9480918362, 0.7212522641, -0.1591424567, -1.7875566145, 1.4937784730, 1.5238957218
];

#[rustfmt::skip]
const Y_QR3: [f64; 80] = [
    -0.3124659090, 0.3054106304, 3.9704941902, 1.3751857489, -1.4367984532, 5.2827743125, 2.9359893661, 3.3828030633, 1.8083772491, -1.0682893736, 2.8817613486, 2.1894834615, -0.7151793235, -2.1531455977, 1.3116795668, 4.7417296135, 6.3063808549, 0.6267053636, 1.8809201919, 0.9369537751, -2.9951112302, 1.2568130526, 0.2944043068, -1.5949854561, -2.3048807856, -3.4846773345, -3.4850804602, -2.9246130528, -2.0806814903, 2.0418981472, 7.3077326130, -3.9562113614, 2.9654995093, 1.6124308653, -1.8643018547, -0.0616333643, 2.0569674439, -7.9623530332, 3.7456912371, 6.9411055816, -0.9361584348, -5.7983189349, -2.0911031685, 0.8673337752, -2.9725926676, -4.3223117306, 0.4469640836, -0.8177147305, 1.6032690928, -0.2229623022, 4.9427327331, -0.4297367476, -0.1493241695, -3.0441117779, -4.3508544606, 1.7006347368, 0.6452636950, -1.5794891451, -2.5190530825, -3.3856599439, -3.9897382652, -1.0414735180, 4.2788830854, -7.1949918985, -1.4472181466, -1.4538959881, 0.8528417863, -0.3536401928, -1.3915310865, -7.9787775736, 1.2515938102, -2.0831892533, -4.6961218613, 3.6471225607, -1.1013108941, 2.0034658176, -1.3472255394, -4.0142991509, 1.3948928989, 1.6518994121
];

const EXPECTED_INTERCEPT_QR3_TAU50: f64 = 0.4635596364;
#[rustfmt::skip]
const EXPECTED_COEFS_QR3_TAU50: [f64; 3] = [1.3713290462, -0.7841535505, 1.7597914059];

#[test]
fn test_r_validation_quantile_multiple_regression() {
    let x = Mat::from_fn(N_QR3, P_QR3, |i, j| X_QR3[i + j * N_QR3]);
    let y = Col::from_fn(N_QR3, |i| Y_QR3[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.5)
        .build()
        .fit(&x, &y)
        .expect("fit should succeed");

    let result = fitted.result();
    let intercept = result.intercept.expect("intercept should exist");

    // Multiple regression with quantile loss - looser tolerance
    assert_relative_eq!(intercept, EXPECTED_INTERCEPT_QR3_TAU50, epsilon = 1.5);

    for (i, expected) in EXPECTED_COEFS_QR3_TAU50.iter().enumerate() {
        assert_relative_eq!(result.coefficients[i], *expected, epsilon = 0.5);
    }
}

// =============================================================================
// Test 6: No Intercept
// =============================================================================
// R Code: rq(y ~ x - 1, tau = 0.5)

const N_QR6: usize = 60;

#[rustfmt::skip]
const X_QR6: [f64; 60] = [
    1.8882799398, 7.4021902855, 5.1059586832, 4.5922332942, 6.5435773795, 2.1949309872, 1.7257744614, 6.9687508743, 8.1418680905, 4.3602979113, 8.1899843575, 8.2955715919, 8.7815467396, 4.8047487838, 1.8628496269, 8.9433471428, 3.5980283481, 3.7459739996, 8.3449465735, 6.2819956599, 6.9646401647, 6.7997659144, 3.0544278424, 6.4892725984, 5.3770928283, 6.2201722194, 8.3140480914, 5.4533375385, 1.7382990993, 5.1741993234, 6.3853460138, 9.2249056743, 1.4322229435, 8.3628584680, 1.7888034438, 3.4387114902, 8.6267090032, 9.2683771306, 1.7383732246, 6.0180847016, 1.3845625264, 3.3480019474, 2.6916782258, 6.1067545838, 1.5911334949, 4.9379369277, 5.9779227790, 5.8618071429, 3.2904345649, 2.4866085064, 7.5500297006, 2.8554207431, 6.2781897353, 9.2219137980, 2.8626994055, 8.4863544160, 3.7801787171, 2.6958023275, 5.6705024573, 2.6563205838
];

#[rustfmt::skip]
const Y_QR6: [f64; 60] = [
    3.9628756426, 17.6389987980, 14.2460879183, 11.1201239520, 17.4726971418, 5.6690866973, 4.8397909720, 16.4408166786, 20.3526746356, 10.7814625080, 19.0497358070, 20.2518171597, 21.6870000789, 12.2450613354, 4.2512680230, 23.0644753354, 9.6344281837, 7.3207565076, 19.7122029961, 14.1879060745, 17.0424353918, 18.8390192164, 7.9691442542, 14.9581031372, 13.8810107889, 15.2076642064, 20.9242413231, 13.7584075423, 2.8132004331, 14.2021094632, 16.8977250299, 22.6371111948, 2.0961649398, 19.3061804185, 5.3985100295, 9.4967286416, 20.8985326259, 23.6488259685, 4.7934960669, 16.7191037591, 3.9845422864, 10.3025404398, 6.9792096091, 16.0145389541, 4.9789139093, 12.2667038256, 17.0639421904, 15.3807818945, 9.4818908843, 6.5466208359, 20.1670690766, 7.1358807007, 16.4708997254, 23.6216020902, 8.3912755100, 21.6807844678, 9.6294696678, 6.2001149936, 13.2185104957, 5.4387082355
];

const EXPECTED_COEF_QR6: f64 = 2.5229334229;

#[test]
fn test_r_validation_quantile_no_intercept() {
    let x = Mat::from_fn(N_QR6, 1, |i, _| X_QR6[i]);
    let y = Col::from_fn(N_QR6, |i| Y_QR6[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.5)
        .with_intercept(false)
        .build()
        .fit(&x, &y)
        .expect("fit should succeed");

    let result = fitted.result();

    assert!(result.intercept.is_none());
    assert_relative_eq!(result.coefficients[0], EXPECTED_COEF_QR6, epsilon = 0.1);
}

// =============================================================================
// Additional Tests
// =============================================================================

#[test]
fn test_quantile_prediction_consistency() {
    let x = Mat::from_fn(N_QR1, 1, |i, _| X_QR1[i]);
    let y = Col::from_fn(N_QR1, |i| Y_QR1[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.5)
        .build()
        .fit(&x, &y)
        .expect("fit should succeed");

    // Predictions should equal fitted values on training data
    let predictions = fitted.predict(&x);
    let fitted_values = &fitted.result().fitted_values;

    for i in 0..N_QR1 {
        assert_relative_eq!(predictions[i], fitted_values[i], epsilon = 1e-10);
    }
}

#[test]
fn test_quantile_pseudo_r_squared() {
    let x = Mat::from_fn(N_QR2, 1, |i, _| X_QR2[i]);
    let y = Col::from_fn(N_QR2, |i| Y_QR2[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.5)
        .build()
        .fit(&x, &y)
        .expect("fit should succeed");

    // Pseudo RÂ² should be between 0 and 1 for a reasonable fit
    let pseudo_r2 = fitted.pseudo_r_squared();
    assert!(pseudo_r2 >= 0.0);
    assert!(pseudo_r2 <= 1.0);

    // For this dataset with clear linear trend, RÂ² should be reasonable
    assert!(pseudo_r2 > 0.3);
}
