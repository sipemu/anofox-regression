//! Extended Quantile Regression Validation Tests
//!
//! Validates against R's quantreg package using classic datasets:
//! - Engel food expenditure (Koenker & Bassett 1982)
//! - Stackloss multivariate data
//! - Extreme quantiles (0.01, 0.05, 0.95, 0.99)
//! - Outlier robustness comparison
//! - Heavy-tailed distributions
//! - Small sample edge cases

use anofox_regression::solvers::{FittedRegressor, QuantileRegressor, Regressor};
use faer::{Col, Mat};

// =============================================================================
// Test 1: Engel Food Expenditure Dataset
// Classic heteroscedastic example from Koenker & Bassett (1982)
// 235 Belgian working class households: food expenditure vs income
// =============================================================================
const N_ENGEL: usize = 235;
#[rustfmt::skip]
const X_ENGEL: [f64; 235] = [
    420.157651, 541.411707, 901.157457, 639.080229, 750.875606, 945.798931, 829.397887, 979.164836, 1309.878940, 1492.398744, 502.838980, 616.716847, 790.922511, 555.878642, 713.441184, 838.756133, 535.076646, 596.440805, 924.561897, 487.758302, 692.639734, 997.876978, 506.999491, 654.158711, 933.919270, 433.681329, 587.596213, 896.474636, 454.478224, 584.998919, 800.799017, 502.436870, 713.519667, 906.000629, 880.596924, 796.828919, 854.879053, 1167.371594, 523.800036, 670.779185, 377.058369, 851.543002, 1121.093694, 625.517933, 805.537696, 558.581201, 884.400487, 1257.498866, 2051.178941, 1466.332992, 730.098897, 800.799017, 1245.696388, 1201.000214, 634.400209, 956.231463, 1148.601047, 1768.823650, 2822.533035, 922.354832, 2293.191971, 627.472597, 889.980898, 1162.199954, 1197.079357, 530.797185, 1142.152593, 1088.003887, 484.661156, 1536.020101, 678.897392, 671.880166, 690.468256, 860.694826, 873.309485, 894.459835, 1148.646992, 926.876193, 839.041358, 829.497421, 1264.004330, 1937.977146, 698.831741, 920.419919, 1897.571140, 891.682386, 889.678356, 1221.481811, 544.599139, 1031.449115, 1462.949672, 830.435282, 975.041467, 1337.998340, 867.642705, 725.745934, 989.005606, 1525.000474, 672.196024, 923.397682, 472.321548, 590.760092, 940.921769, 643.357141, 2551.661514, 1795.322589, 1165.773390, 815.621174, 1264.206586, 1095.405617, 447.447852, 1178.974180, 975.802296, 1017.852200, 423.879832, 558.776739, 943.248718, 1348.300245, 2340.617354, 587.179168, 1540.974057, 1115.848075, 1044.684286, 1389.792869, 2497.785954, 1585.380943, 1862.043836, 2008.854624, 697.309948, 571.251747, 598.346489, 461.097723, 977.110747, 883.984917, 718.359399, 543.897059, 1587.348035, 4957.813024, 969.683762, 419.998021, 561.998960, 689.598814, 1398.520261, 820.816848, 875.171616, 1392.449910, 1256.317372, 1362.859030, 1999.255220, 1209.472992, 1125.035647, 1827.400967, 1014.153953, 880.394410, 2432.390992, 1177.854686, 1222.593866, 1519.581125, 687.663762, 953.119224, 953.119224, 953.119224, 939.041806, 1283.402457, 1511.578881, 1342.582128, 511.797992, 689.798827, 1532.307426, 1056.080825, 387.319526, 387.319526, 410.998679, 832.755432, 614.998605, 887.465813, 1024.817677, 1006.435339, 725.999989, 494.417351, 748.641327, 987.641720, 788.096071, 831.798314, 1139.494475, 507.516894, 576.197221, 696.599054, 650.817978, 949.580207, 497.119281, 570.167399, 724.730600, 408.339934, 638.671348, 1225.789003, 715.370078, 800.470756, 975.597399, 1613.756548, 608.501879, 958.663378, 835.942641, 873.737511, 951.443210, 473.002181, 601.003044, 713.997885, 829.298365, 959.795269, 1212.961295, 958.874307, 1129.443147, 1943.041873, 539.638786, 463.599021, 562.640005, 736.758383, 1415.446064, 2208.789706, 636.000914, 759.401027, 1078.838200, 499.751013, 1020.022536, 1595.161079, 776.595793, 1230.923525, 1807.952015, 415.440748, 440.517424, 541.200597, 581.359892, 743.077243, 1057.676711
];
#[rustfmt::skip]
const Y_ENGEL: [f64; 235] = [
    255.839425, 310.958667, 485.680014, 402.997356, 495.560775, 633.797815, 630.756568, 700.440904, 830.958622, 815.360217, 338.001387, 412.361338, 520.000618, 452.401473, 512.720058, 658.839530, 392.599497, 443.558634, 640.116378, 333.839387, 466.958319, 543.396904, 317.719844, 424.320896, 518.961656, 338.001387, 419.641175, 476.320049, 386.360163, 423.278350, 503.357171, 354.638869, 497.318169, 588.519464, 654.597145, 550.727428, 528.376977, 640.481348, 401.320356, 435.999022, 276.560610, 588.348818, 664.197802, 444.860166, 462.899515, 377.779239, 553.150436, 810.896155, 1067.954056, 1049.878792, 522.701210, 572.080663, 907.396945, 811.577594, 427.797520, 649.998464, 860.600155, 1143.421086, 2032.679190, 590.618327, 1570.391138, 483.480025, 600.480399, 696.202106, 774.796179, 390.598430, 612.561901, 708.762152, 296.919186, 1071.462696, 496.597580, 503.397441, 357.641111, 430.337593, 624.699041, 582.541251, 580.221542, 543.880743, 588.637180, 627.999895, 712.101174, 968.394940, 482.581588, 593.169386, 1033.565754, 693.679473, 693.679473, 761.279066, 361.398056, 628.452218, 771.448564, 757.118666, 821.596994, 1022.320170, 679.440727, 538.749116, 679.998097, 977.003271, 561.201488, 728.399747, 372.318623, 361.520953, 517.919591, 459.817651, 863.919851, 831.440717, 534.761044, 392.050242, 934.975195, 813.308096, 263.709996, 769.083849, 630.586286, 645.987401, 319.558386, 348.451830, 614.506803, 662.009562, 1504.370775, 406.218016, 692.168899, 588.137051, 511.260886, 700.559989, 1301.145098, 879.066017, 912.885078, 1509.781172, 484.060549, 399.670317, 444.100106, 248.810111, 527.801360, 500.631349, 436.810735, 374.799044, 726.392135, 1827.199964, 523.491085, 334.999822, 473.200884, 581.202946, 929.753967, 591.197417, 637.548275, 674.950935, 776.758895, 959.516968, 1250.964334, 737.820079, 810.677242, 983.000865, 708.896829, 633.120014, 1424.804656, 830.958622, 925.579474, 1162.002397, 383.457963, 621.117329, 621.117329, 621.117329, 548.600231, 745.235294, 837.800496, 795.340242, 418.597568, 508.797450, 883.278012, 742.527569, 242.320202, 242.320202, 266.000982, 614.758803, 385.318398, 515.619969, 708.478703, 734.235631, 433.000984, 327.418772, 429.039934, 619.640828, 400.798978, 620.800640, 819.996441, 360.878018, 395.760805, 442.000052, 404.038431, 670.799309, 297.570151, 353.488163, 383.937585, 284.800803, 431.099965, 801.351759, 448.451259, 577.911071, 570.521012, 865.320536, 444.557764, 680.419827, 576.277894, 631.798175, 608.641850, 300.999920, 377.998414, 397.001477, 588.519464, 681.761575, 807.360270, 696.801097, 811.196242, 1305.720141, 442.000052, 353.601297, 468.000798, 526.757347, 890.239030, 1318.803282, 331.000538, 416.401525, 596.840555, 408.499218, 775.020903, 1138.162046, 485.519766, 772.761142, 993.963017, 305.438974, 306.519079, 299.199328, 468.000798, 522.601906, 750.320163
];

// Expected coefficients from R quantreg::rq() for various tau values
const EXPECTED_ENGEL_INTERCEPT_TAU05: f64 = 124.8800408126;
const EXPECTED_ENGEL_SLOPE_TAU05: f64 = 0.3433610576;
const EXPECTED_ENGEL_INTERCEPT_TAU10: f64 = 110.1415742049;
const EXPECTED_ENGEL_SLOPE_TAU10: f64 = 0.4017657593;
const EXPECTED_ENGEL_INTERCEPT_TAU25: f64 = 95.4835396346;
const EXPECTED_ENGEL_SLOPE_TAU25: f64 = 0.4741032082;
const EXPECTED_ENGEL_INTERCEPT_TAU50: f64 = 81.4822474169;
const EXPECTED_ENGEL_SLOPE_TAU50: f64 = 0.5601805512;
const EXPECTED_ENGEL_INTERCEPT_TAU75: f64 = 62.3965855290;
const EXPECTED_ENGEL_SLOPE_TAU75: f64 = 0.6440141394;
const EXPECTED_ENGEL_INTERCEPT_TAU90: f64 = 67.3508720801;
const EXPECTED_ENGEL_SLOPE_TAU90: f64 = 0.6862994804;
const EXPECTED_ENGEL_INTERCEPT_TAU95: f64 = 64.1039631811;
const EXPECTED_ENGEL_SLOPE_TAU95: f64 = 0.7090685170;

// =============================================================================
// Test 2: Stackloss Dataset (Multivariate)
// =============================================================================
const N_STACK: usize = 21;
const P_STACK: usize = 3;
#[rustfmt::skip]
const X_STACK: [f64; 63] = [
    80.0, 80.0, 75.0, 62.0, 62.0, 62.0, 62.0, 62.0, 58.0, 58.0, 58.0, 58.0, 58.0, 58.0, 50.0, 50.0, 50.0, 50.0, 50.0, 56.0, 70.0,
    27.0, 27.0, 25.0, 24.0, 22.0, 23.0, 24.0, 24.0, 23.0, 18.0, 18.0, 17.0, 18.0, 19.0, 18.0, 18.0, 19.0, 19.0, 20.0, 20.0, 20.0,
    89.0, 88.0, 90.0, 87.0, 87.0, 87.0, 93.0, 93.0, 87.0, 80.0, 89.0, 88.0, 82.0, 93.0, 89.0, 86.0, 72.0, 79.0, 80.0, 82.0, 91.0
];
#[rustfmt::skip]
const Y_STACK: [f64; 21] = [
    42.0, 37.0, 37.0, 28.0, 18.0, 18.0, 19.0, 20.0, 15.0, 14.0, 14.0, 13.0, 11.0, 12.0, 8.0, 7.0, 8.0, 8.0, 9.0, 15.0, 15.0
];

// tau = 0.25 (8 of 21 points lie exactly on this plane)
const EXPECTED_STACK_INTERCEPT_TAU25: f64 = -36.0;
const EXPECTED_STACK_AIRFLOW_TAU25: f64 = 0.5;
const EXPECTED_STACK_WATERTEMP_TAU25: f64 = 1.0;
const EXPECTED_STACK_ACIDCONC_TAU25: f64 = 0.0;
// tau = 0.50 (median)
const EXPECTED_STACK_INTERCEPT_TAU50: f64 = -39.6898550725;
const EXPECTED_STACK_AIRFLOW_TAU50: f64 = 0.8318840580;
const EXPECTED_STACK_WATERTEMP_TAU50: f64 = 0.5739130435;
const EXPECTED_STACK_ACIDCONC_TAU50: f64 = -0.0608695652;
// tau = 0.75
const EXPECTED_STACK_INTERCEPT_TAU75: f64 = -54.1896551724;
const EXPECTED_STACK_AIRFLOW_TAU75: f64 = 0.8706896552;
const EXPECTED_STACK_WATERTEMP_TAU75: f64 = 0.9827586207;
const EXPECTED_STACK_ACIDCONC_TAU75: f64 = 0.0;

// =============================================================================
// Test 3: Extreme Quantiles
// =============================================================================
const N_EXTREME: usize = 500;
#[rustfmt::skip]
const X_EXTREME: [f64; 500] = [
    91.4806043496, 93.7075413298, 28.6139534786, 83.0447626067, 64.1745518893, 51.9095949130, 73.6588314641, 13.4666597238, 65.6992290402, 70.5064784037, 45.7741776248, 71.9112251652, 93.4672247153, 25.5428824341, 46.2292822544, 94.0014522756, 97.8226428386, 11.7487361655, 47.4997081561, 56.0332746245, 90.4031387297, 13.8710167725, 98.8891728921, 94.6668232558, 8.2437558100, 51.4211784350, 39.0203467105, 90.5738130910, 44.6969628101, 83.6004259996, 73.7595617771, 81.1055141268, 38.8108282816, 68.5169729404, 0.3948338795, 83.2916080253, 0.7334146881, 20.7658972824, 90.6601407798, 61.1778643448, 37.9559240537, 43.5771584976, 3.7431032863, 97.3539913772, 43.1751248892, 95.7576596644, 88.7754905503, 63.9978769468, 97.0966610359, 61.8838207331, 33.3427211270, 34.6748248208, 39.8485411424, 78.4692775691, 3.8936491124, 74.8795386171, 67.7276830189, 17.1264330391, 26.1087963823, 51.4412934659, 67.5607274519, 98.2817197917, 75.9544267552, 56.6488424083, 84.9689718569, 18.9473935403, 27.1286614705, 82.8158485238, 69.3204820389, 24.0544739645, 4.2988796020, 14.0479094116, 21.6385415057, 47.9398564203, 19.7410342284, 71.9355837675, 0.7884738734, 37.5489964616, 51.4407708310, 0.1570554217, 58.1604002509, 15.7905208180, 35.9028305858, 64.5631878404, 77.5823362637, 56.3646841561, 23.3703398611, 8.9980516350, 8.5612064926, 30.5218369467, 66.7426514672, 0.0238896580, 20.8569956943, 93.3034127345, 92.5644748611, 73.4094301006, 33.3071983419, 51.5063329833, 74.3974646321, 61.9159240043, 62.6245344523, 21.7157698236, 21.6567310970, 38.8945028652, 94.2455691984, 96.2608013768, 73.9855279215, 73.3245905722, 53.5761289997, 0.2272966085, 60.8937452547, 83.6801559431, 75.1522562699, 45.2731572557, 53.5789993824, 53.7376695313, 0.1380843576, 35.5665953830, 61.2133090151, 82.8942130553, 35.6721999357, 41.0635125823, 57.3475898942, 58.9678303571, 71.9657292357, 39.4973045215, 91.9203929137, 96.2570293574, 23.3523525530, 72.4497599993, 90.3634525137, 60.3474084754, 63.1507298909, 93.7385849655, 85.0482750684, 57.9820899060, 82.1403923910, 11.3718609093, 76.4507758664, 62.3613457195, 14.8446606705, 8.0264466582, 46.4069551323, 77.9368161457, 73.3527959557, 81.7230444402, 17.0162481256, 94.4720325526, 29.3623841368, 14.9072052445, 71.9378591282, 32.4085952481, 77.8809498530, 39.4441001816, 67.8592867916, 77.5825042743, 18.7869044021, 2.9085818911, 13.5713797063, 68.0164178135, 93.4822953772, 55.0494084368, 60.1766235428, 19.6994488128, 53.5236610565, 17.9555739276, 45.1886494411, 31.7053351784, 11.6174670402, 18.6102156760, 72.9730096646, 41.1872071214, 41.4049681742, 48.0310129002, 42.7494465606, 13.6490360135, 82.4679406360, 59.2304242542, 79.4396977639, 76.9032425713, 91.8056417257, 86.2629777053, 31.6975237802, 25.9260575986, 74.2266451940, 74.7361116810, 91.7904034024, 79.3191209203, 13.3329618257, 28.7749752169, 19.4676143816, 78.4109382657, 12.8872161731, 12.9089283524, 7.2253111284, 5.3129483480, 53.1874436419, 11.2308241660, 74.3187719723, 73.1315477286, 88.5117687052, 51.7111055553, 85.1930984994, 44.2796268268, 15.7880100422, 44.2324638832, 96.7733667232, 48.4587929444, 25.2458439441, 25.9689980187, 54.2015940882, 64.9875837611, 33.6419132305, 6.0949746286, 45.1310850214, 83.8755033445, 57.4637334328, 35.3350377409, 54.7426078236, 89.2718593823, 48.9990570582, 17.1632113168, 54.3030994013, 96.1467695888, 31.3683822053, 82.0514548104, 30.7054400444, 18.5453581158, 4.8346776748, 24.5674147271, 35.1106922142, 15.9022381762, 30.4097996792, 1.7548324773, 99.6552679222, 80.4393312661, 8.6580601754, 86.9933269685, 55.4585863370, 42.1378421830, 6.7636819091, 56.1437956523, 7.0721894270, 21.1391938850, 54.9620413454, 48.1981448364, 15.9469854552, 14.9578995071, 49.9272880377, 94.0564878052, 33.4231326589, 18.8434329582, 26.9716178300, 53.0744078103, 2.1450228523, 79.8760307487, 11.0335100209, 53.9798285812, 57.1233897470, 61.8951546960, 71.4853693498, 12.3300578678, 31.1049618758, 94.5739162620, 50.0025092391, 13.5230499087, 86.9257820537, 20.5049612094, 92.5045890966, 88.6753598228, 13.6295825243, 78.5349442158, 45.3303414164, 13.5742419399, 88.5221036850, 33.6713540135, 31.9274115143, 40.3782814741, 47.9077307042, 36.7901820224, 46.5690567624, 4.9892152892, 18.7356711598, 98.2659413712, 32.8274069587, 17.0996390516, 48.8254894502, 1.8687411677, 33.9485083707, 2.9663375579, 86.7228663061, 73.1707599713, 31.5260796808, 38.6454011779, 33.2445990527, 8.9777971152, 75.7055602502, 60.2968497202, 14.5399972564, 3.2517483458, 48.3768141596, 44.4569527870, 6.0385589954, 32.7506022062, 87.8429047298, 93.0604886264, 39.2178456997, 15.8846774837, 31.9947601063, 30.6965620257, 10.7811254449, 97.9334303411, 49.6903428109, 9.3074671924, 21.1773658171, 93.0500746239, 29.6846406767, 65.3218248859, 90.1070477907, 99.0795793245, 43.0333221331, 39.3776922254, 14.1908895457, 27.9806696344, 56.4822222572, 93.5139505425, 35.8400145080, 84.2007180909, 72.2409214359, 75.0735989306, 92.3988452181, 0.2378106816, 16.0429914948, 39.9272951297, 67.5319577334, 48.0372016318, 53.3828780754, 31.6950157285, 81.4757590182, 29.2219521245, 40.9132091329, 9.0918307658, 79.8596638022, 35.9785249690, 4.0487576742, 4.1086339857, 95.4434238374, 37.3341244878, 80.6419667555, 91.0059008980, 44.0076212864, 57.6336503029, 7.3667795165, 16.4627394406, 73.9890775876, 47.5711012725, 68.5520953266, 95.1514942804, 49.7464487562, 47.0500626601, 56.0191950062, 65.2510120533, 27.9573498759, 97.9907589499, 64.3864108017, 58.2578435773, 61.5871025948, 92.5140294479, 39.0022895299, 28.7919685012, 9.0735964710, 32.2033904027, 75.8270112565, 10.4412929621, 71.0277852602, 96.6477383627, 20.1491226209, 10.8488654485, 5.5402178783, 82.9723515082, 58.1197756575, 47.0092375297, 36.5014120005, 28.0124627287, 59.9715854973, 81.8569612922, 9.7832280444, 96.3689526077, 16.8736443389, 8.6083405884, 86.1210695701, 52.4790602038, 65.6810875284, 22.9519372806, 72.1226031426, 49.0750394994, 96.5255592484, 90.6942480477, 55.1250527846, 7.5599099509, 2.2700011265, 51.3239527820, 63.0726151634, 41.8771624332, 87.9265945172, 10.7987073017, 98.0278696399, 26.4966631308, 8.4277523216, 38.5907175718, 12.4895827146, 58.1554221688, 24.0149608115, 72.1887888620, 14.5928690676, 15.2838770300, 25.9222670225, 77.7886260068, 42.6466299687, 6.0048336163, 11.4832537016, 48.2756897341, 97.9173583910, 81.1516786925, 54.2912817094, 7.2367087007, 46.6485246085, 33.9905645931, 68.9918605145, 51.4157372061, 51.4923015609, 54.5514354017, 44.7457330069, 8.3884840365, 93.0133691756, 1.6448186245, 41.4092399413, 22.6976093370, 9.9640587345, 48.2923875097, 65.0128671434, 92.1329778386, 36.2601807108, 85.5134990066, 30.0906151533, 46.5662425151, 14.2730664928, 80.7718993630, 66.5807631798, 6.1940979911, 43.0925568333, 39.6855081432, 69.6956751402, 65.9319650615, 40.7350709662, 30.6920220377, 25.5107345060, 67.2568153357, 89.4393433584, 84.5736156218, 39.2901856918, 7.9050539993, 82.8423056984, 7.2891824879, 11.4762677578, 63.9984270092, 32.0566200186, 18.8749526162, 39.3829641165, 86.2026015995, 34.7911406541, 0.1433898462, 91.1284453701, 95.1723448932, 49.0918983007, 46.3651715312, 59.6472046804, 90.6050957274, 17.3001179006, 78.5881076707, 23.2934384607, 57.7048209030, 84.0877033304, 13.2203776855, 89.5891189575, 45.0137341162, 89.4142537843, 24.8545180541, 8.3695293637, 4.8641074682, 97.9815867031, 48.4167741146, 84.5393033931, 41.6293604532, 48.9342542831, 18.3287817519, 75.9161467897, 30.5143302539, 16.5678247111, 3.2809142955
];
#[rustfmt::skip]
const Y_EXTREME: [f64; 500] = [
    44.7787397592, 57.3442751743, 12.3220181737, 53.4225712890, 55.0643349407, 25.6160602269, 39.4450081899, 17.1989692564, 32.6736533218, 41.4203996030, 41.6146429291, 55.6510627223, 60.5720790079, 4.2558845864, 32.5746737589, 67.6484582812, 67.0432717934, 13.9662033417, 6.7505559924, 38.6263037003, 60.9390863397, 17.3935441835, 61.0187118478, 61.6490653566, 10.1563805445, 48.8103714750, 34.2141073540, 42.8602038398, 46.1642359689, 63.8448023699, 55.1205205254, 33.9264630416, 23.7123507047, 50.6136246431, 10.6346370156, 55.1259270493, 34.9626428328, 12.1991453972, 34.1980692406, 43.3258848967, 22.1019936144, 36.2489897784, 3.7477044052, 80.7975504919, 30.3505027288, 53.1054747719, 52.7251303603, 50.6245723097, 59.5217353700, 24.6857429744, 26.6251528852, 34.9398340870, 30.3141796999, 56.5853602007, 10.4820982862, 46.8608959547, 48.6875361705, 28.4926528873, 10.5904432108, 35.3857714845, 43.0707419135, 51.5516533585, 37.6336197682, 32.0171016645, 58.3525631286, 15.3104702083, 15.7154526402, 53.0420874567, 32.2930986684, 32.4859747446, 7.3034856388, 18.9152428226, 21.3293340686, 33.9675215213, 37.9643375386, 37.7145123126, 21.8489414590, 29.0902301063, 27.3683273624, 9.3908912207, 46.5479169956, 13.6400730650, 20.2305929410, 43.8092349877, 58.6771365837, 37.4477587313, 7.8149043950, 1.4322667737, 6.5966499955, 19.9898372196, 43.1570550832, 16.7169255390, 16.0823274614, 45.5129085341, 62.3532973794, 49.4592847377, 38.2270698651, 18.9283578968, 48.0719232050, 54.4915809416, 48.5540052330, 12.5323566542, 28.1536504162, 20.7279827326, 52.5888094869, 70.0057434747, 44.0913108428, 54.9477567357, 33.8757874121, -5.6499757432, 31.9587156579, 40.9548793520, 42.7332224238, 29.2734665378, 35.2559207846, 34.4363624799, 28.9910625948, 13.9233143186, 36.4584115005, 54.9379218087, 44.1205226260, 31.4169752483, 51.0653020311, 23.0383598210, 60.4464298716, 22.8430505441, 53.1958856023, 47.0343270797, 23.0148694408, 64.0782705170, 79.4033598094, 29.4054152165, 46.4347760495, 70.7545098702, 50.5675693614, 36.8092969759, 48.0224166500, 21.6642576958, 62.1996820414, 48.0568704722, 20.6242104782, 10.9945240713, 38.1869644217, 43.4730388937, 43.8838329415, 61.8266566512, 22.9282549446, 59.6461792166, 22.1251155148, 26.7639316371, 59.3180554179, 17.5115799853, 49.4953444731, 30.2127192227, 38.1460861122, 38.8038655772, 19.3691244010, 18.0094097737, 31.5541126429, 24.9166810240, 49.7167529555, 34.4104020383, 23.4567414647, 12.3443899885, 28.9883129365, 11.7520899652, 10.7059787291, 27.9868530921, 9.4895041575, 34.5100197763, 54.4460643264, 16.0583079094, 31.6864382971, 28.0777966078, 40.2575349667, 17.3552221617, 45.6637340595, 43.9991824888, 51.2459304684, 46.8054454681, 76.1017270776, 47.8376299895, 21.1408921602, 7.5036595591, 46.7080553640, 56.2716188952, 35.1813231919, 47.1589092594, 4.8499766463, 38.8068602586, 33.3127625796, 52.5504976063, 30.7369888906, 7.7812856674, 23.1191728139, 6.8063590877, 39.8032970462, 12.6214519163, 44.3739551532, 52.0269254476, 41.2176728162, 33.3464081272, 54.3066229869, 28.1051386259, 18.9405994294, 28.9274240743, 74.5701227204, 41.3712824871, 52.2815756704, 15.0337229637, 45.2444561909, 63.4740999819, 29.8307571668, 2.2167358959, 22.5023174927, 51.5836060231, 51.8231103249, 35.1715237369, 15.9876206357, 47.6323886025, 34.4089637762, 4.0002707860, 44.0968461656, 33.4600300425, 27.1170887430, 47.1135062139, 20.4410791661, 16.4362045334, 15.5652868845, 26.2469731429, 25.2993089968, -1.2983852153, 10.8126068564, -3.8191615011, 67.4462684300, 47.7835158143, 17.0257961619, 37.9073882747, 32.3734131016, 36.6934408232, 11.5985797203, 36.9205379641, 12.8154799924, 32.6786950118, 31.3320516647, 40.8603370013, 26.9594887830, 5.5857707184, 36.1762325171, 56.9160270413, 37.0029735226, 28.5694651563, 23.4612462482, 37.8972994293, 3.8709759767, 47.9567720738, 5.2246669500, 27.3203553321, 26.3535639843, 49.3096543874, 56.8924026599, 12.0355804046, 14.2627069578, 56.4076448132, 57.4202915527, 37.1746566618, 36.2648876597, 16.6834140435, 71.5850994699, 53.9552389453, 32.7889236854, 45.9316181748, 38.7150299474, 19.0295333625, 86.5517467973, 36.0402026745, 13.8983150650, 24.1503290454, 37.6562181983, 9.3850845444, 15.2404289316, 1.2763815811, 15.8885395143, 71.5219921719, 23.6717278308, 20.1736266814, 33.7666756276, 3.8819996136, 40.5962268728, 0.5180368981, 51.0770979676, 43.1070991795, 31.0843260355, 45.3950462116, 31.7604447875, 28.3126301633, 55.4837506106, 33.9025794137, 18.0854366325, 25.3866652865, 18.5757492182, 35.4761829994, 11.4513763282, 35.1531397105, 61.4231181167, 59.5407783516, 44.5370340222, 2.6874007402, 35.1045556380, 9.5529607343, 21.2677252936, 59.8631381305, 44.5177879750, 15.4418571254, 4.9016845437, 36.4468054718, 30.2520555807, 41.9271464619, 49.3433399597, 56.4291050637, 24.8025103955, 28.1154415919, 7.7823940629, 4.1602400225, 36.0451130861, 67.2097339659, 46.6933029170, 52.1264210050, 45.3137613708, 57.1666222777, 56.7351327745, 5.7699212517, 0.6485231940, 17.3266915670, 47.8290639874, 19.4220611381, 47.1760127392, 12.3832024697, 48.8021739280, 24.5876164911, 30.3283072278, 16.0653886028, 55.9149432151, 26.7271381115, 9.5390231786, 13.6575909419, 53.3852925027, 44.0411864349, 28.6185176116, 65.7729966419, 29.5189813113, 43.0400290098, 23.5599226946, 26.5870514407, 40.3893202033, 49.4262455692, 28.0462883104, 66.2147108750, 29.7571966437, 14.3513810756, 19.3514590169, 45.0772966611, 46.2140179571, 61.7291401164, 53.5010533461, 47.5156155293, 34.2473985186, 65.7966245088, 33.0306594198, 26.4619771771, 24.5479305786, 33.5762151178, 41.6477572610, 19.1728833404, 36.5922130897, 64.6320532822, 15.7475094776, 19.9458191664, 16.4500993911, 48.7823008575, 43.7150140059, 39.2481810211, 25.9437060987, 35.7286564474, 53.9128198160, 44.3085680890, 7.1179219549, 63.3198620930, 9.3036997890, 9.8099322417, 61.0898617761, 30.5047615921, 23.5592920857, 28.1198769785, 30.0358993334, 20.9915171752, 28.0834528300, 63.6595022461, 40.0734972808, 18.4028896349, 19.5829227955, 35.2422611478, 30.4805485247, 36.5763377399, 66.9969448168, 0.3971442729, 52.9440424688, 20.3258809088, 1.3170427276, 36.2364172736, 10.2529723283, 51.6467775241, 22.5425605420, 53.3753196077, 32.9074152159, 20.2981860510, 33.7283961033, 51.0012923202, 16.2065797261, 13.2264394073, 22.9229889112, 39.0324150455, 57.2197957367, 38.3988444596, 43.6096245418, 4.4537940668, 20.8060278800, 32.9445594806, 32.1678236054, 38.1515127521, 35.7738726339, 23.9936208406, 44.1698306218, 8.2661920268, 68.5064677512, 6.0720725161, 24.9540490091, 21.0365444224, 11.4014594075, 30.5801829784, 33.7297897374, 43.9375176675, 34.2629565423, 44.6947160887, 11.2807382776, 28.2046422659, 9.1271783790, 28.4580928248, 40.3810100972, 14.7687902072, 34.4932019815, 33.7701667258, 34.8394004401, 39.7087113325, 20.2840474288, 18.9916961985, 10.6569603731, 32.4637696613, 61.0184833050, 49.5615921091, 27.0566811621, 31.2481087986, 50.8372311951, 8.2739533978, 23.2110008406, 37.1266351507, 39.7573878241, 15.6607527016, 23.5299559171, 41.4200502890, 30.6819739130, 24.7368011975, 52.0041272342, 60.2008488654, 37.8792377021, 47.4045181687, 46.4623683468, 44.5659963067, 11.6810412036, 41.8327492660, 23.0624479517, 38.8129382442, 55.7232266761, 10.0367596958, 51.0310927771, 39.9204676624, 53.7110593277, 15.8843602410, 23.8964084225, 12.5670168498, 49.8254466813, 51.3052726699, 40.5886417971, 13.0043176251, 11.9358026559, 25.6756505714, 42.6297471388, 22.5015715572, 21.1801820818, 6.9756165298
];

// Expected coefficients from R for extreme quantiles
const EXPECTED_EXTREME_INTERCEPT_TAU01: f64 = -6.4833192052;
const EXPECTED_EXTREME_SLOPE_TAU01: f64 = 0.3803897250;
const EXPECTED_EXTREME_INTERCEPT_TAU05: f64 = -4.3357829997;
const EXPECTED_EXTREME_SLOPE_TAU05: f64 = 0.4382864671;
const EXPECTED_EXTREME_INTERCEPT_TAU95: f64 = 25.9291765252;
const EXPECTED_EXTREME_SLOPE_TAU95: f64 = 0.4781951142;
const EXPECTED_EXTREME_INTERCEPT_TAU99: f64 = 32.0023850740;
const EXPECTED_EXTREME_SLOPE_TAU99: f64 = 0.5083326190;

// =============================================================================
// Test 4: Outlier Robustness
// =============================================================================
const N_OUTLIER: usize = 50;
#[rustfmt::skip]
const X_OUTLIER: [f64; 50] = [
    1.0, 1.1836734694, 1.3673469388, 1.5510204082, 1.7346938776, 1.9183673469, 2.1020408163, 2.2857142857, 2.4693877551, 2.6530612245, 2.8367346939, 3.0204081633, 3.2040816327, 3.3877551020, 3.5714285714, 3.7551020408, 3.9387755102, 4.1224489796, 4.3061224490, 4.4897959184, 4.6734693878, 4.8571428571, 5.0408163265, 5.2244897959, 5.4081632653, 5.5918367347, 5.7755102041, 5.9591836735, 6.1428571429, 6.3265306122, 6.5102040816, 6.6938775510, 6.8775510204, 7.0612244898, 7.2448979592, 7.4285714286, 7.6122448980, 7.7959183673, 7.9795918367, 8.1632653061, 8.3469387755, 8.5306122449, 8.7142857143, 8.8979591837, 9.0816326531, 9.2653061224, 9.4489795918, 9.6326530612, 9.8163265306, 10.0
];
#[rustfmt::skip]
const Y_OUTLIER: [f64; 50] = [
    2.6959699125, 2.8006183061, 3.8806704490, 4.4138933759, 3.4631520359, 5.0228132609, 5.3642144032, 6.0759401102, 5.7864386419, 56.0820687571, 6.5574038542, 6.5210418603, 6.7662652753, 7.1396248853, 7.7292295392, 7.4170077595, 7.6583987894, 7.7510924310, 7.9803050318, 8.8980938632, 9.7838901945, 8.8012845013, 9.4670042767, 9.3217341131, -29.4337118811, 10.2290641697, 10.7527672894, 11.1127896041, 10.6871462036, 11.4374237743, 11.6511348139, 12.3784941077, 11.6997041839, 11.9918559625, 13.2502802271, 12.8488082122, 13.0882194320, 13.7503843121, 13.8091883553, 75.1780887077, 14.6501738911, 14.8766984028, 15.5369660261, 15.3169654009, 15.6468188296, 15.3615214833, 15.0269836725, 15.8453761668, 16.7815445108, 16.4833514604
];

const EXPECTED_OUTLIER_MEDIAN_INTERCEPT: f64 = 2.0809614093;
const EXPECTED_OUTLIER_MEDIAN_SLOPE: f64 = 1.4700266358;
const TRUE_OUTLIER_INTERCEPT: f64 = 2.0;
const TRUE_OUTLIER_SLOPE: f64 = 1.5;

// =============================================================================
// Test 5: Heavy-Tailed Distribution
// =============================================================================
const N_HEAVY: usize = 100;
#[rustfmt::skip]
const X_HEAVY: [f64; 100] = [
    7.5452787033, 6.6134196147, 7.6579945162, 1.4284203434, 5.8604397019, 7.0726884808, 4.2009253870, 9.9089717632, 0.8601816022, 5.4911532439, 3.7868449115, 3.8772052946, 3.2530933572, 9.9645660305, 7.4640809582, 7.7978995978, 9.0467006620, 6.6672499478, 6.9182861829, 9.4606942544, 1.2959903735, 9.5056661055, 9.5263889665, 0.8785267686, 8.4383690660, 7.5712276064, 5.8843506267, 3.0500255525, 0.1367504569, 3.2319239853, 1.6989364801, 2.1876107808, 4.7266473062, 0.0802978384, 7.7676280611, 7.9142124113, 1.1901915912, 1.9362545083, 9.9933908228, 9.0323140053, 0.0532734185, 7.2378972825, 4.0674196393, 0.2291844343, 3.9760057954, 1.7753636767, 2.5354779488, 9.1364476015, 3.7486678176, 2.9976514657, 7.7107602614, 0.1431666710, 1.9097944163, 9.9930607714, 0.1863409672, 7.1788122156, 5.3735323297, 3.9146627393, 4.9927399470, 9.8992637824, 4.9477374484, 9.7667867923, 7.4792301212, 6.8450490152, 4.9474700214, 0.5451729824, 7.8113939054, 3.4628991201, 0.2217671019, 6.2277454301, 1.2962185335, 1.7984821554, 6.3638011343, 1.6873236117, 3.6208227417, 2.2092450480, 8.2761302218, 0.0364273996, 1.5751587809, 9.3720426643, 7.6543727238, 8.2163318200, 2.5180109381, 1.1755572329, 1.3284558058, 4.1936002416, 3.6587251024, 1.4477343950, 5.1985087874, 7.4579037749, 1.0978319356, 3.6960247625, 2.2243185760, 8.9697397058, 1.0634878231, 8.3899958711, 8.4536951897, 0.2691652090, 7.6534820674, 2.7482523932
];
#[rustfmt::skip]
const Y_HEAVY: [f64; 100] = [
    18.1125969528, 16.8146166850, 21.7295279183, 9.2561589519, 17.5168331105, 19.6432683236, 13.6059595516, 23.6336463789, 14.3683094412, 18.4831582868, 15.0995537200, 16.5604526515, 10.1292869048, 22.5964241530, 23.1308558248, 19.0875697836, 22.5846701094, 11.3687242314, 19.0803380951, 20.4777974232, 7.8741126280, 24.8345517613, 21.5518194147, 7.7135722066, 25.1268057818, 24.3501854452, 17.9891732248, 11.0071192505, 6.3663038295, 11.9550853835, 8.3931580276, 10.2337173398, 15.4985006481, 2.6252600551, 12.1234236226, 23.0027116561, 9.2773471248, 5.7453520527, 25.4064903860, 23.2265731371, 3.1819760217, 21.5455746082, 15.2630262953, 2.0427311622, 8.0018058230, 0.4579013751, 10.6444749983, 24.0600610217, 16.2390527774, 12.3724510444, 20.3870423752, 8.9130041801, 6.3520503896, 25.1478167551, 6.8440470028, 22.0369376742, 14.5529252975, 13.5720746357, 17.5737444826, 24.3078271015, 15.7597947308, 26.3728787989, 17.6551889280, 20.3928224799, 18.8460133363, 3.8860017355, 20.2967600409, 9.6579644199, 5.6740221621, 13.2047502202, 11.2817960748, 10.2443921998, 18.5538143936, 9.3703358052, 12.8633841623, 8.0334124290, 22.0050970375, 0.4663624690, 9.5806703934, 24.9762989495, 19.3467615806, 19.5728152244, 11.0663411864, 8.5984293285, 8.7527462582, 22.0029066851, 12.1570130972, 8.1514428731, 15.1608758034, 16.5772602663, 6.3469832763, 13.4633548750, 14.9668348716, 22.6536484251, 5.2051144094, 19.1764063745, 10.9130447181, 2.4248270252, 17.3506338355, 13.8124095169
];

const EXPECTED_HEAVY_INTERCEPT: f64 = 6.0601937487;
const EXPECTED_HEAVY_SLOPE: f64 = 1.8819898458;

// =============================================================================
// Test 6: Small Sample
// =============================================================================
const N_SMALL: usize = 10;
#[rustfmt::skip]
const X_SMALL: [f64; 10] = [1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0];
#[rustfmt::skip]
const Y_SMALL: [f64; 10] = [
    3.5975674988, 3.9584598041, 5.2807406692, 4.8049146715, 5.1990450315, 5.8394658261, 6.4668756300, 7.1801290508, 7.6247535179, 7.9682748060
];

const EXPECTED_SMALL_INTERCEPT: f64 = 2.9550934738;
const EXPECTED_SMALL_SLOPE: f64 = 0.5016831652;

// Tolerance - IRLS vs simplex can differ more
const TOLERANCE_INTERCEPT: f64 = 50.0;
const TOLERANCE_SLOPE: f64 = 0.15;

fn create_design_matrix(x: &[f64], n: usize) -> Mat<f64> {
    Mat::from_fn(n, 1, |i, _| x[i])
}

fn create_multivariate_matrix(x: &[f64], n: usize, p: usize) -> Mat<f64> {
    // Data is in column-major order
    Mat::from_fn(n, p, |i, j| x[j * n + i])
}

// =============================================================================
// Engel Dataset Tests
// =============================================================================

#[test]
fn test_engel_median_regression() {
    let x = create_design_matrix(&X_ENGEL, N_ENGEL);
    let y = Col::from_fn(N_ENGEL, |i| Y_ENGEL[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.5)
        .with_intercept(true)
        .build()
        .fit(&x, &y)
        .unwrap();

    let result = fitted.result();
    let intercept = result.intercept.expect("intercept should exist");
    let slope = result.coefficients[0];

    let intercept_err = (intercept - EXPECTED_ENGEL_INTERCEPT_TAU50).abs();
    let slope_err = (slope - EXPECTED_ENGEL_SLOPE_TAU50).abs();

    assert!(
        intercept_err < TOLERANCE_INTERCEPT,
        "Engel median intercept: expected {}, got {}, error {}",
        EXPECTED_ENGEL_INTERCEPT_TAU50,
        intercept,
        intercept_err
    );
    assert!(
        slope_err < TOLERANCE_SLOPE,
        "Engel median slope: expected {}, got {}, error {}",
        EXPECTED_ENGEL_SLOPE_TAU50,
        slope,
        slope_err
    );
}

#[test]
fn test_engel_multiple_quantiles() {
    let x = create_design_matrix(&X_ENGEL, N_ENGEL);
    let y = Col::from_fn(N_ENGEL, |i| Y_ENGEL[i]);

    // Test tau = 0.25
    let fit_25 = QuantileRegressor::builder()
        .tau(0.25)
        .with_intercept(true)
        .build()
        .fit(&x, &y)
        .unwrap();
    let result_25 = fit_25.result();
    let slope_25 = result_25.coefficients[0];

    // Test tau = 0.75
    let fit_75 = QuantileRegressor::builder()
        .tau(0.75)
        .with_intercept(true)
        .build()
        .fit(&x, &y)
        .unwrap();
    let result_75 = fit_75.result();
    let slope_75 = result_75.coefficients[0];

    // Verify slopes increase with tau (heteroscedastic data)
    // Higher quantiles should have steeper slopes
    assert!(
        slope_75 > slope_25,
        "Q75 slope ({}) should be greater than Q25 slope ({}) for heteroscedastic data",
        slope_75,
        slope_25
    );

    // Check against R values
    assert!(
        (slope_25 - EXPECTED_ENGEL_SLOPE_TAU25).abs() < TOLERANCE_SLOPE,
        "Q25 slope error too large: expected {}, got {}",
        EXPECTED_ENGEL_SLOPE_TAU25,
        slope_25
    );
    assert!(
        (slope_75 - EXPECTED_ENGEL_SLOPE_TAU75).abs() < TOLERANCE_SLOPE,
        "Q75 slope error too large: expected {}, got {}",
        EXPECTED_ENGEL_SLOPE_TAU75,
        slope_75
    );
}

// =============================================================================
// Stackloss Tests
// =============================================================================

#[test]
fn test_stackloss_multivariate() {
    let x = create_multivariate_matrix(&X_STACK, N_STACK, P_STACK);
    let y = Col::from_fn(N_STACK, |i| Y_STACK[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.5)
        .with_intercept(true)
        .build()
        .fit(&x, &y)
        .unwrap();

    let result = fitted.result();
    let intercept = result.intercept.expect("intercept should exist");

    // Check coefficients (with larger tolerance for small multivariate)
    let tol = 20.0;
    assert!(
        (intercept - EXPECTED_STACK_INTERCEPT_TAU50).abs() < tol,
        "Stackloss intercept: expected {}, got {}",
        EXPECTED_STACK_INTERCEPT_TAU50,
        intercept
    );
}

#[test]
fn test_stackloss_q25_exact_fit() {
    // Famous edge case: 8 of 21 points lie exactly on Q25 plane
    let x = create_multivariate_matrix(&X_STACK, N_STACK, P_STACK);
    let y = Col::from_fn(N_STACK, |i| Y_STACK[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.25)
        .with_intercept(true)
        .build()
        .fit(&x, &y)
        .unwrap();

    let result = fitted.result();

    // Due to the exact fit, this should be very close to R's values
    let tol = 1.0;
    assert!(
        (result.coefficients[0] - EXPECTED_STACK_AIRFLOW_TAU25).abs() < tol,
        "Stackloss Q25 airflow coefficient: expected {}, got {}",
        EXPECTED_STACK_AIRFLOW_TAU25,
        result.coefficients[0]
    );
}

// =============================================================================
// Extreme Quantile Tests
// =============================================================================

#[test]
fn test_extreme_quantile_01() {
    let x = create_design_matrix(&X_EXTREME, N_EXTREME);
    let y = Col::from_fn(N_EXTREME, |i| Y_EXTREME[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.01)
        .with_intercept(true)
        .build()
        .fit(&x, &y)
        .unwrap();

    let result = fitted.result();
    let slope = result.coefficients[0];

    // Very extreme quantile - larger tolerance
    let tol = 0.5;
    assert!(
        (slope - EXPECTED_EXTREME_SLOPE_TAU01).abs() < tol,
        "Extreme Q01 slope: expected {}, got {}",
        EXPECTED_EXTREME_SLOPE_TAU01,
        slope
    );
}

#[test]
fn test_extreme_quantile_99() {
    let x = create_design_matrix(&X_EXTREME, N_EXTREME);
    let y = Col::from_fn(N_EXTREME, |i| Y_EXTREME[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.99)
        .with_intercept(true)
        .build()
        .fit(&x, &y)
        .unwrap();

    let result = fitted.result();
    let slope = result.coefficients[0];

    // Very extreme quantile - larger tolerance
    let tol = 0.5;
    assert!(
        (slope - EXPECTED_EXTREME_SLOPE_TAU99).abs() < tol,
        "Extreme Q99 slope: expected {}, got {}",
        EXPECTED_EXTREME_SLOPE_TAU99,
        slope
    );
}

#[test]
fn test_extreme_quantiles_ordering() {
    let x = create_design_matrix(&X_EXTREME, N_EXTREME);
    let y = Col::from_fn(N_EXTREME, |i| Y_EXTREME[i]);

    // Get intercepts at different quantiles
    let mut intercepts = Vec::new();
    for tau in [0.01, 0.05, 0.5, 0.95, 0.99] {
        let fit = QuantileRegressor::builder()
            .tau(tau)
            .with_intercept(true)
            .build()
            .fit(&x, &y)
            .unwrap();
        let result = fit.result();
        intercepts.push(result.intercept.expect("intercept"));
    }

    // Intercepts should generally increase with tau (for positive slope)
    // But this is not strictly monotonic, so just verify no crashes
    assert_eq!(intercepts.len(), 5);
}

// =============================================================================
// Outlier Robustness Tests
// =============================================================================

#[test]
fn test_outlier_robustness() {
    let x = create_design_matrix(&X_OUTLIER, N_OUTLIER);
    let y = Col::from_fn(N_OUTLIER, |i| Y_OUTLIER[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.5)
        .with_intercept(true)
        .build()
        .fit(&x, &y)
        .unwrap();

    let result = fitted.result();
    let intercept = result.intercept.expect("intercept");
    let slope = result.coefficients[0];

    // Median regression should be close to true values despite outliers
    let intercept_err_from_true = (intercept - TRUE_OUTLIER_INTERCEPT).abs();
    let slope_err_from_true = (slope - TRUE_OUTLIER_SLOPE).abs();

    // Should be reasonably close to true values
    assert!(
        intercept_err_from_true < 2.0,
        "Median intercept should be robust to outliers: err = {}",
        intercept_err_from_true
    );
    assert!(
        slope_err_from_true < 0.2,
        "Median slope should be robust to outliers: err = {}",
        slope_err_from_true
    );
}

// =============================================================================
// Heavy-Tailed Distribution Tests
// =============================================================================

#[test]
fn test_heavy_tailed_distribution() {
    let x = create_design_matrix(&X_HEAVY, N_HEAVY);
    let y = Col::from_fn(N_HEAVY, |i| Y_HEAVY[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.5)
        .with_intercept(true)
        .build()
        .fit(&x, &y)
        .unwrap();

    let result = fitted.result();
    let intercept = result.intercept.expect("intercept");
    let slope = result.coefficients[0];

    // Check against R values
    assert!(
        (intercept - EXPECTED_HEAVY_INTERCEPT).abs() < 5.0,
        "Heavy-tailed intercept: expected {}, got {}",
        EXPECTED_HEAVY_INTERCEPT,
        intercept
    );
    assert!(
        (slope - EXPECTED_HEAVY_SLOPE).abs() < 0.5,
        "Heavy-tailed slope: expected {}, got {}",
        EXPECTED_HEAVY_SLOPE,
        slope
    );
}

// =============================================================================
// Small Sample Tests
// =============================================================================

#[test]
fn test_small_sample() {
    let x = create_design_matrix(&X_SMALL, N_SMALL);
    let y = Col::from_fn(N_SMALL, |i| Y_SMALL[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.5)
        .with_intercept(true)
        .build()
        .fit(&x, &y)
        .unwrap();

    let result = fitted.result();
    let intercept = result.intercept.expect("intercept");
    let slope = result.coefficients[0];

    assert!(
        (intercept - EXPECTED_SMALL_INTERCEPT).abs() < 2.0,
        "Small sample intercept: expected {}, got {}",
        EXPECTED_SMALL_INTERCEPT,
        intercept
    );
    assert!(
        (slope - EXPECTED_SMALL_SLOPE).abs() < 0.3,
        "Small sample slope: expected {}, got {}",
        EXPECTED_SMALL_SLOPE,
        slope
    );
}

// =============================================================================
// Prediction Tests
// =============================================================================

#[test]
fn test_engel_predictions() {
    let x = create_design_matrix(&X_ENGEL, N_ENGEL);
    let y = Col::from_fn(N_ENGEL, |i| Y_ENGEL[i]);

    let fitted = QuantileRegressor::builder()
        .tau(0.5)
        .with_intercept(true)
        .build()
        .fit(&x, &y)
        .unwrap();

    let predictions = fitted.predict(&x);

    // All predictions should be finite
    for i in 0..N_ENGEL {
        assert!(
            predictions[i].is_finite(),
            "Prediction {} should be finite",
            i
        );
    }

    // Predictions should be in reasonable range
    let min_pred = predictions.iter().cloned().fold(f64::INFINITY, f64::min);
    let max_pred = predictions
        .iter()
        .cloned()
        .fold(f64::NEG_INFINITY, f64::max);

    assert!(min_pred > 0.0, "Predictions should be positive for food expenditure");
    assert!(max_pred < 3000.0, "Predictions should be reasonable");
}
